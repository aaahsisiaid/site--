<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>📍 Firestore 地図 & 削除 + 写真プレビュー</title>
<style>
  body { margin: 0; font-family: sans-serif; }
  #map { height: 100vh; width: 100vw; }
  #preview {
    position: absolute;
    top: 0; left: 0;
    width: 66.6vw;
    height: 100vh;
    background: rgba(0,0,0,0.9);
    color: white;
    display: none;
    flex-wrap: wrap;
    align-content: flex-start;
    overflow-y: auto;
    z-index: 999;
    padding: 10px;
  }
  #preview img {
    max-width: calc(50% - 10px);
    margin: 5px;
    border: 2px solid #fff;
  }
  #previewClose {
    position: absolute;
    top: 5px; right: 10px;
    color: white;
    font-size: 18px;
    background: transparent;
    border: none;
    cursor: pointer;
  }
  .delete-button {
    background: red;
    color: white;
    font-size: 12px;
    border: none;
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
  }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getFirestore, collection, query, orderBy, getDocs, deleteDoc, doc
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
    authDomain: "picture-storage-906ae.firebaseapp.com",
    projectId: "picture-storage-906ae",
    storageBucket: "picture-storage-906ae.firebasestorage.app",
    messagingSenderId: "134265329367",
    appId: "1:134265329367:web:b94063426b6307f8a8c292",
    measurementId: "G-9CP3F27EMF"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let map;
  const markers = [];

  async function loadData() {
    const snapshot = await getDocs(query(collection(db, "photos_with_location"), orderBy("createdAt", "desc")));
    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

    if (!map) {
      map = L.map('map').setView([35.68, 139.76], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
    }

    for (const marker of markers) marker.remove();
    markers.length = 0;

    for (const item of data) {
      const { lat, lon } = item.location || {};
      if (!lat || !lon) continue;

      const m = L.marker([lat, lon]).addTo(map);
      markers.push(m);

      // 左クリック: 写真をオーバーレイ表示
      m.on('click', () => {
        const preview = document.getElementById('preview');
        preview.innerHTML = '<button id="previewClose">✖</button>';

        const allPhotos = [...(item.rearPhotos || []), ...(item.frontPhotos || [])];
        for (const p of allPhotos) {
          const img = document.createElement('img');
          img.src = p;
          preview.appendChild(img);
        }
        preview.style.display = 'flex';

        document.getElementById('previewClose').onclick = () => {
          preview.style.display = 'none';
        };
      });

      // 右クリック: 削除ボタン表示
      m.on('contextmenu', (e) => {
        const popup = L.popup()
          .setLatLng(e.latlng)
          .setContent(`<button class="delete-button">削除</button>`)
          .openOn(map);

        setTimeout(() => {
          const btn = document.querySelector('.delete-button');
          if (btn) {
            btn.onclick = async () => {
              if (confirm("この記録を削除しますか？")) {
                await deleteDoc(doc(db, "photos_with_location", item.id));
                loadData(); // 再読み込み
              }
            };
          }
        }, 0);
      });
    }

    if (data.length > 0 && data[0].location?.lat) {
      map.setView([data[0].location.lat, data[0].location.lon], 13);
    }
  }

  window.onload = loadData;
</script>
</head>
<body>
<div id="preview"></div>
<div id="map"></div>
</body>
</html>
