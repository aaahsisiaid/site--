<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å†™çœŸãƒ»ä½ç½®æƒ…å ±ã¾ã¨ã‚ã‚µã‚¤ãƒˆ</title>
<style>
  body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
  #map { height: 400px; width: 100%; }
  #list { max-height: 400px; overflow-y: auto; padding: 10px; background: #f0f0f0; }
  .item { border-bottom: 1px solid #ccc; padding: 5px; }
  img { max-width: 100px; max-height: 75px; margin-right: 5px; vertical-align: middle; }
  button { margin: 10px; padding: 10px 15px; font-size: 16px; cursor: pointer; }
</style>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
    authDomain: "picture-storage-906ae.firebaseapp.com",
    projectId: "picture-storage-906ae",
    storageBucket: "picture-storage-906ae.firebasestorage.app",
    messagingSenderId: "134265329367",
    appId: "1:134265329367:web:b94063426b6307f8a8c292",
    measurementId: "G-9CP3F27EMF"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.addEventListener('DOMContentLoaded', () => {
    const listEl = document.getElementById("list");
    const openCameraBtn = document.getElementById("openCamera");
    let map, markers = [];

    // Google Maps åˆæœŸåŒ–é–¢æ•°
    window.initMap = function() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.0, lng: 135.0 },
        zoom: 7
      });
    };

    // Firestoreã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—ã—ã¦è¡¨ç¤º
    const q = query(collection(db, "photos_with_location"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      listEl.innerHTML = "";
      // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
      markers.forEach(m => m.setMap(null));
      markers = [];

      snapshot.forEach(doc => {
        const data = doc.data();

        // æ—¥ä»˜ã¨ä½ç½®æƒ…å ±
        const dateStr = new Date(data.createdAt).toLocaleString();
        const loc = data.location || {};

        // å†™çœŸã‚’ã¾ã¨ã‚ã¦imgã‚¿ã‚°ã«å¤‰æ›ï¼ˆè¤‡æ•°æšã‚ã‚‹æƒ³å®šï¼‰
        const photosHTML = [];
        if(data.rearPhotos) {
          data.rearPhotos.forEach((p,i) => photosHTML.push(`<img alt="rear${i+1}" src="${p}">`));
        }
        if(data.frontPhotos) {
          data.frontPhotos.forEach((p,i) => photosHTML.push(`<img alt="front${i+1}" src="${p}">`));
        }

        const itemHTML = document.createElement("div");
        itemHTML.className = "item";
        itemHTML.innerHTML = `
          <div><strong>${dateStr}</strong></div>
          <div>ç·¯åº¦: ${loc.lat ?? "ä¸æ˜"}, çµŒåº¦: ${loc.lon ?? "ä¸æ˜"}</div>
          <div>${photosHTML.join('')}</div>
        `;
        listEl.appendChild(itemHTML);

        // åœ°å›³ã«ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        if(loc.lat && loc.lon && !isNaN(loc.lat) && !isNaN(loc.lon)) {
          const marker = new google.maps.Marker({
            position: { lat: loc.lat, lng: loc.lon },
            map: map,
            title: dateStr
          });
          markers.push(marker);
        }
      });
    });

    // æ’®å½±ã‚µã‚¤ãƒˆã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ããƒœã‚¿ãƒ³å‹•ä½œ
    openCameraBtn.addEventListener("click", () => {
      window.open("æ’®å½±ã‚µã‚¤ãƒˆã®URLã‚’ã“ã“ã«å…¥ã‚Œã¦ãã ã•ã„.html", "_blank");
    });
  });
</script>

<!-- Google Maps API èª­ã¿è¾¼ã¿ -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap">
</script>

</head>
<body>
  <h1>ğŸ“· å†™çœŸãƒ»ä½ç½®æƒ…å ±ã¾ã¨ã‚ã‚µã‚¤ãƒˆ</h1>
  <button id="openCamera">ğŸ“¸ æ’®å½±ãƒšãƒ¼ã‚¸ã‚’é–‹ã</button>
  <div id="map"></div>
  <div id="list"></div>
</body>
</html>
