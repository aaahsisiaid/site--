<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firestore写真＋位置情報＋マップ画像プレビュー＋削除</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100vh; display: flex; font-family: Arial, sans-serif;
    background: #f7f7f7;
  }
  #preview {
    width: 33.33%;
    overflow-y: auto;
    background: #222;
    color: white;
    padding: 10px;
    box-sizing: border-box;
  }
  #preview h2 {
    margin-top: 0;
  }
  #preview img {
    width: 100%;
    margin-bottom: 10px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.8);
  }
  #map {
    width: 66.67%;
    height: 100vh;
  }
  #list {
    position: absolute;
    top: 10px; right: 10px;
    max-height: 90vh;
    width: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 14px;
    z-index: 1000;
  }
  .item {
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  .item img {
    max-width: 80px;
    margin-right: 5px;
    vertical-align: middle;
    border-radius: 4px;
  }
  .delete-btn {
    background: #d33;
    color: white;
    border: none;
    padding: 3px 8px;
    cursor: pointer;
    font-size: 12px;
    border-radius: 3px;
    margin-left: 5px;
  }
</style>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getFirestore, collection, query, orderBy, getDocs, deleteDoc, doc
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  // Firebase設定（差し替え必要）
  const firebaseConfig = {
    apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
    authDomain: "picture-storage-906ae.firebaseapp.com",
    projectId: "picture-storage-906ae",
    storageBucket: "picture-storage-906ae.firebasestorage.app",
    messagingSenderId: "134265329367",
    appId: "1:134265329367:web:b94063426b6307f8a8c292",
    measurementId: "G-9CP3F27EMF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let map;
  let markers = [];
  let currentPreviewId = null;  // 今プレビュー表示中のid

  async function loadData() {
    const listEl = document.getElementById("list");
    const previewEl = document.getElementById("preview");
    listEl.innerHTML = "";
    previewEl.innerHTML = "<h2>画像プレビュー</h2><p>左クリックで画像表示、右クリックで削除メニュー</p>";

    const q = query(collection(db, "photos_with_location"), orderBy("createdAt", "asc"));
    const snapshot = await getDocs(q);
    const data = snapshot.docs.map(docSnap => ({
      id: docSnap.id,
      ...docSnap.data()
    }));

    // 地図初期化（初回のみ）
    if (!map) {
      map = L.map('map').setView([35.68, 139.76], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
    }

    // 既存マーカー削除
    markers.forEach(m => m.remove());
    markers = [];

    data.forEach(item => {
      const loc = item.location || {};
      const rearPhotos = item.rearPhotos || [];
      const frontPhotos = item.frontPhotos || [];

      // リストに表示
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <b>日時:</b> ${new Date(item.createdAt).toLocaleString()}<br>
        <b>位置:</b> 緯度 ${loc.lat || "不明"} / 経度 ${loc.lon || "不明"}<br>
        <div>
          ${rearPhotos.map(src => `<img src="${src}" alt="rear">`).join('')}
          ${frontPhotos.map(src => `<img src="${src}" alt="front">`).join('')}
          <button class="delete-btn">削除</button>
        </div>
      `;
      // 削除ボタン（リスト用）
      div.querySelector(".delete-btn").onclick = async () => {
        if (confirm("この記録を削除しますか？")) {
          await deleteDoc(doc(db, "photos_with_location", item.id));
          if(currentPreviewId === item.id) {
            previewEl.innerHTML = "<h2>画像プレビュー</h2><p>左クリックで画像表示、右クリックで削除メニュー</p>";
            currentPreviewId = null;
          }
          loadData();
        }
      };
      listEl.appendChild(div);

      // マーカーを地図に追加
      if (loc.lat && loc.lon && !isNaN(loc.lat) && !isNaN(loc.lon)) {
        const marker = L.marker([loc.lat, loc.lon]).addTo(map);

        // 左クリックでプレビュー表示
        marker.on('click', () => {
          currentPreviewId = item.id;
          previewEl.innerHTML = `<h2>日時: ${new Date(item.createdAt).toLocaleString()}</h2>
          <h3>外カメラ写真</h3>
          ${rearPhotos.map(src => `<img src="${src}">`).join('')}
          <h3>内カメラ写真</h3>
          ${frontPhotos.map(src => `<img src="${src}">`).join('')}
          <button id="delPreviewBtn" style="
            margin-top:10px; background:#d33; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">
            削除
          </button>`;
          document.getElementById("delPreviewBtn").onclick = async () => {
            if (confirm("この記録を削除しますか？")) {
              await deleteDoc(doc(db, "photos_with_location", item.id));
              previewEl.innerHTML = "<h2>画像プレビュー</h2><p>左クリックで画像表示、右クリックで削除メニュー</p>";
              currentPreviewId = null;
              loadData();
            }
          };
        });

        // 右クリック（コンテキストメニュー抑止して削除ボタンだけ表示）
        marker.on('contextmenu', (e) => {
          e.originalEvent.preventDefault();
          currentPreviewId = item.id;
          previewEl.innerHTML = `<h2>削除確認</h2>
          <p>この記録を削除しますか？</p>
          <button id="confirmDeleteBtn" style="
            background:#d33; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">
            削除実行
          </button>
          <button id="cancelDeleteBtn" style="
            margin-left:10px; background:#777; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">
            キャンセル
          </button>`;
          document.getElementById("confirmDeleteBtn").onclick = async () => {
            await deleteDoc(doc(db, "photos_with_location", item.id));
            previewEl.innerHTML = "<h2>画像プレビュー</h2><p>左クリックで画像表示、右クリックで削除メニュー</p>";
            currentPreviewId = null;
            loadData();
          };
          document.getElementById("cancelDeleteBtn").onclick = () => {
            previewEl.innerHTML = "<h2>画像プレビュー</h2><p>左クリックで画像表示、右クリックで削除メニュー</p>";
            currentPreviewId = null;
          };
        });

        markers.push(marker);
      }
    });

    // 初期ズームは最新データの位置へ
    if (data.length > 0 && data[data.length -1].location?.lat) {
      const lastLoc = data[data.length -1].location;
      map.setView([lastLoc.lat, lastLoc.lon], 13);
    }
  }

  window.onload = loadData;
</script>
</head>
<body>
  <div id="preview">
    <h2>画像プレビュー</h2>
    <p>左クリックで画像表示、右クリックで削除メニュー</p>
  </div>
  <div id="map"></div>
  <div id="list"></div>
</body>
</html>
