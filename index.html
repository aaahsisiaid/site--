<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firestore 写真＋位置情報一覧・地図表示</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  #list { max-height: 300px; overflow-y: auto; background: #eee; padding: 10px; }
  .item { border-bottom: 1px solid #ccc; padding: 5px; }
  .photos img { max-width: 100px; margin-right: 5px; }
  #map { height: 400px; }
</style>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  // Firebase設定（ご自身の環境に変更してください）
  const firebaseConfig = {
    apiKey: "AIzaSyDgwbExA5BKTcKsq2Ov8z173Ke6EPYGf28",
    authDomain: "picture-storage-906ae.firebaseapp.com",
    projectId: "picture-storage-906ae",
    storageBucket: "picture-storage-906ae.firebasestorage.app",
    messagingSenderId: "134265329367",
    appId: "1:134265329367:web:b94063426b6307f8a8c292",
    measurementId: "G-9CP3F27EMF"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.onload = async () => {
    const listEl = document.getElementById("list");

    // Firestoreコレクション参照・時間昇順で取得
    const q = query(collection(db, "photos_with_location"), orderBy("createdAt", "asc"));
    const snapshot = await getDocs(q);

    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // Leaflet地図初期化（初期位置は最初のデータの位置 or 日本中心など）
    let map = L.map('map').setView([35.68, 139.76], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // 各データをリスト表示し、地図にマーカー追加
    data.forEach(item => {
      const loc = item.location || {};
      const rearPhotos = item.rearPhotos || [];
      const frontPhotos = item.frontPhotos || [];

      // リストHTML
      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <div><b>日時:</b> ${new Date(item.createdAt).toLocaleString()}</div>
        <div><b>位置情報:</b> 緯度 ${loc.lat || "不明"} / 経度 ${loc.lon || "不明"}</div>
        <div class="photos">
          ${rearPhotos.map(src => `<img src="${src}" alt="rear photo">`).join('')}
          ${frontPhotos.map(src => `<img src="${src}" alt="front photo">`).join('')}
        </div>
      `;
      listEl.appendChild(div);

      // 位置情報が有効なら地図にマーカー追加
      if(loc.lat && loc.lon && !isNaN(loc.lat) && !isNaN(loc.lon)) {
        L.marker([loc.lat, loc.lon]).addTo(map)
          .bindPopup(`<b>${new Date(item.createdAt).toLocaleString()}</b><br>緯度:${loc.lat}<br>経度:${loc.lon}`);
      }
    });

    // 最初の位置にズーム
    if(data.length > 0 && data[0].location && data[0].location.lat && data[0].location.lon) {
      map.setView([data[0].location.lat, data[0].location.lon], 13);
    }
  };
</script>
</head>
<body>
  <h1>Firestore保存写真・位置情報一覧</h1>
  <div id="list"></div>
  <div id="map"></div>
</body>
</html>
